<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Solar Word Game - Canvas Version</title>
        <style>
            body {
                margin: 0;
                padding: 10px;
                background: #0a0a2e;
                color: white;
                font-family: Arial, sans-serif;
                min-height: 100vh;
                /* Prevent zoom on input focus on iOS */
                -webkit-text-size-adjust: 100%;
            }

            .game-layout {
                display: flex;
                gap: 20px;
                max-width: 1200px;
                margin: 0 auto;
                align-items: flex-start;
            }

            .game-area {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                min-width: 0; /* Prevent flex overflow */
            }

            .sidebar {
                width: 300px;
                display: flex;
                flex-direction: column;
                gap: 20px;
            }

            #score-panel {
                background: #1a1a3e;
                border-radius: 8px;
                padding: 20px;
                text-align: center;
                cursor: pointer;
            }

            #score-panel h2 {
                margin: 0 0 10px 0;
                font-size: 28px;
                color: #ffdd44;
            }

            .rank {
                font-size: 18px;
                color: #4ecdc4;
                margin-bottom: 5px;
            }

            .score {
                font-size: 16px;
                color: #ccc;
            }

            .word-bank {
                background: #1a1a3e;
                border-radius: 8px;
                padding: 20px;
                flex: 1;
            }

            .word-bank h3 {
                margin: 0 0 15px 0;
                text-align: center;
            }

            #gameCanvas {
                border: 2px solid #444;
                border-radius: 10px;
                cursor: pointer;
                background: radial-gradient(
                    circle at center,
                    #1a1a4e 0%,
                    #0a0a2e 70%
                );
                max-width: 100%;
                height: auto;
            }

            .controls {
                margin: 20px 0;
                text-align: center;
                max-width: 500px;
                width: 100%;
            }

            .instructions {
                margin: 20px 0;
                padding: 15px;
                background: #1a1a3e;
                border-radius: 8px;
                max-width: 500px;
                width: 100%;
                box-sizing: border-box;
                font-size: 14px;
                text-align: center;
            }

            .keyboard-hint {
                background: #2a2a5e;
                border-radius: 4px;
                padding: 10px;
                font-size: 12px;
                margin-top: 10px;
            }

            button {
                margin: 5px;
                padding: 12px 16px;
                background: #444;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                /* Better touch targets */
                min-height: 44px;
                min-width: 44px;
            }

            button:hover {
                background: #666;
            }

            button:active {
                background: #555;
                transform: scale(0.95);
            }

            .check-button {
                background: #28a745 !important;
                font-size: 14px;
                padding: 12px 20px;
                margin: 5px;
                font-weight: bold;
            }

            .found-words {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin-top: 10px;
            }

            .word-item {
                background: #2a2a5e;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 14px;
                /* Better touch interaction */
                min-height: 32px;
                display: flex;
                align-items: center;
            }

            .results {
                margin: 20px 0;
                padding: 15px;
                background: #2a2a5e;
                border-radius: 8px;
                max-width: 500px;
                width: 100%;
                box-sizing: border-box;
                font-size: 14px;
                line-height: 1.5;
                /* Better text readability on mobile */
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            h1 {
                text-align: center;
                margin-bottom: 20px;
                font-size: clamp(24px, 5vw, 32px);
                padding: 0 10px;
            }

            details {
                text-align: left;
            }

            details[open] {
                text-align: center;
            }

            .ranks-dialog {
                margin: auto;
                padding: 0;
                border: none;
                border-radius: 12px;
                background: transparent;
                width: 600px;
                height: 600px;
                overflow: visible;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            }

            .ranks-dialog::backdrop {
                background: rgba(10, 10, 46, 0.8);
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px); /* Safari support */
            }

            /* Animation support for dialog */
            .ranks-dialog[open] {
                animation: dialogSlideIn 0.3s ease-out;
            }

            .ranks-dialog.closing {
                animation: dialogSlideOut 0.3s ease-in;
            }

            @keyframes dialogSlideIn {
                from {
                    opacity: 0;
                    transform: scale(0.9) translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                }
            }

            @keyframes dialogSlideOut {
                from {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                }
                to {
                    opacity: 0;
                    transform: scale(0.9) translateY(-10px);
                }
            }

            .dialog-content {
                background: linear-gradient(135deg, #1a1a3e 0%, #2a2a5e 100%);
                border: 2px solid #4ecdc4;
                border-radius: 12px;
                height: 100%;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .dialog-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px 25px;
                background: linear-gradient(90deg, #ffdd44, #ffaa00);
                color: #333;
                border-bottom: 2px solid #4ecdc4;
                flex-shrink: 0;
            }

            .dialog-header h2 {
                margin: 0;
                font-size: 24px;
                font-weight: bold;
            }

            .close-button {
                background: none;
                border: none;
                font-size: 28px;
                color: #333;
                cursor: pointer;
                padding: 0;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.2s ease;
                min-height: auto;
                min-width: auto;
            }

            .close-button:hover {
                background: rgba(0, 0, 0, 0.1);
                transform: scale(1.1);
            }

            .dialog-body {
                padding: 25px;
                flex: 1;
                overflow-y: auto;
            }

            .ranks-grid {
                display: grid;
                gap: 15px;
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            }

            .rank-item {
                display: flex;
                align-items: center;
                gap: 15px;
                padding: 15px;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(78, 205, 196, 0.3);
                border-radius: 8px;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }

            .rank-item::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(78, 205, 196, 0.1), transparent);
                transition: left 0.5s ease;
            }

            .rank-item:hover {
                border-color: #4ecdc4;
                background: rgba(78, 205, 196, 0.1);
                transform: translateY(-2px);
            }

            .rank-item:hover::before {
                left: 100%;
            }

            .rank-item.beginner {
                border-color: rgba(255, 107, 107, 0.5);
            }

            .rank-item.legendary {
                border-color: rgba(255, 221, 68, 0.8);
                background: linear-gradient(135deg, rgba(255, 221, 68, 0.1), rgba(255, 170, 0, 0.1));
            }

            .rank-item.legendary::after {
                content: '✨';
                position: absolute;
                top: 5px;
                right: 10px;
                font-size: 12px;
                opacity: 0.7;
            }

            .rank-icon {
                font-size: 28px;
                width: 45px;
                height: 45px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 50%;
                flex-shrink: 0;
            }

            .rank-info {
                flex: 1;
                color: white;
            }

            .rank-info h3 {
                margin: 0 0 5px 0;
                font-size: 16px;
                color: #4ecdc4;
                font-weight: bold;
            }

            .rank-info p {
                margin: 0 0 5px 0;
                font-size: 13px;
                color: #ffdd44;
                font-weight: bold;
            }

            .rank-description {
                font-size: 11px;
                color: #ccc;
                font-style: italic;
                line-height: 1.3;
            }

            /* Tablet adjustments */
            @media (max-width: 768px) and (min-width: 481px) {
                .ranks-dialog {
                    width: 90vw;
                    height: 80vh;
                    max-width: 600px;
                    max-height: 600px;
                }

                .ranks-grid {
                    grid-template-columns: 1fr;
                }
            }

            /* Mobile phones - nearly full screen */
            @media (max-width: 480px) {
                .ranks-dialog {
                    width: 95vw;
                    height: 90vh;
                    border-radius: 8px;
                    margin: auto;
                }

                .dialog-header {
                    padding: 15px 20px;
                }

                .dialog-header h2 {
                    font-size: 20px;
                }

                .close-button {
                    font-size: 24px;
                    width: 35px;
                    height: 35px;
                }

                .dialog-body {
                    padding: 20px;
                }

                .ranks-grid {
                    grid-template-columns: 1fr;
                    gap: 12px;
                }

                .rank-item {
                    padding: 12px;
                    gap: 12px;
                }

                .rank-icon {
                    font-size: 24px;
                    width: 40px;
                    height: 40px;
                }

                .rank-info h3 {
                    font-size: 15px;
                }

                .rank-info p {
                    font-size: 12px;
                }

                .rank-description {
                    font-size: 10px;
                }
            }

            /* Very small phones - full screen */
            @media (max-width: 360px) {
                .ranks-dialog {
                    width: 100vw;
                    height: 100vh;
                    border-radius: 0;
                }

                .dialog-content {
                    border-radius: 0;
                    border: none;
                    border-top: 2px solid #4ecdc4;
                }
            }

            /* Smooth scrolling for the dialog body */
            .dialog-body::-webkit-scrollbar {
                width: 8px;
            }

            .dialog-body::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 4px;
            }

            .dialog-body::-webkit-scrollbar-thumb {
                background: #4ecdc4;
                border-radius: 4px;
            }

            .dialog-body::-webkit-scrollbar-thumb:hover {
                background: #45b7d1;
            }

            /* Mobile-specific optimizations */
            @media (max-width: 768px) {
                body {
                    padding: 5px;
                }

                .game-layout {
                    flex-direction: column;
                    gap: 15px;
                }

                .sidebar {
                    width: 100%;
                    order: -1;
                }

                #score-panel {
                    display: flex;
                    justify-content: space-around;
                    align-items: center;
                    text-align: left;
                    padding: 15px;
                }

                #score-panel h2 {
                    font-size: 24px;
                    margin: 0;
                }

                .rank,
                .score {
                    font-size: 14px;
                }

                #gameCanvas {
                    width: 100%;
                    max-width: 500px;
                    height: auto;
                }

                .instructions {
                    font-size: 13px;
                    padding: 12px;
                    margin: 10px 0;
                }

                .keyboard-hint {
                    font-size: 11px;
                    padding: 8px;
                }

                .controls {
                    margin: 15px 0;
                    display: flex;
                    flex-wrap: wrap;
                    justify-content: center;
                    gap: 10px;
                }

                button {
                    flex: 1;
                    min-width: 120px;
                    max-width: 200px;
                    margin: 2px;
                }

                .word-bank {
                    padding: 15px;
                }

                .word-bank h3 {
                    font-size: 18px;
                    margin-bottom: 10px;
                }

                .found-words {
                    gap: 6px;
                }

                .word-item {
                    font-size: 13px;
                    padding: 6px 10px;
                }

                .results {
                    font-size: 13px;
                    padding: 12px;
                    margin: 15px 0;
                }
            }

            /* Very small screens (phones in portrait) */
            @media (max-width: 480px) {
                h1 {
                    font-size: 24px;
                    margin-bottom: 15px;
                }

                #score-panel {
                    flex-direction: column;
                    gap: 8px;
                    text-align: center;
                }

                #score-panel > div {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    width: 100%;
                }

                .instructions {
                    font-size: 12px;
                }

                .keyboard-hint {
                    display: none; /* Hide on very small screens */
                }

                #gameCanvas {
                    max-width: 400px;
                }

                .controls {
                    flex-direction: column;
                }

                button {
                    width: 100%;
                    max-width: none;
                    margin: 3px 0;
                }

            /* Landscape orientation on mobile */
            @media (max-height: 500px) and (orientation: landscape) {
                .game-layout {
                    flex-direction: row;
                }

                .sidebar {
                    width: 250px;
                    order: 0;
                }

                h1 {
                    margin-bottom: 10px;
                    font-size: 20px;
                }

                .instructions {
                    margin: 10px 0;
                    padding: 10px;
                }

                .keyboard-hint {
                    display: none;
                }
            }
        </style>
    </head>
    <body>
        <h1 style="text-align: center; margin-bottom: 30px">Solar Word Game</h1>

        <div class="game-layout">
            <div class="game-area">
                <div class="instructions">
                    <details>
                        <summary>
                            <strong>How to play:</strong>
                        </summary>
                        <p>
                            Click on an orbital ring to select it, then use
                            arrow keys to rotate. You can also click and drag
                            rings to rotate them. Find words by aligning
                            letters!
                        </p>

                        <div class="keyboard-hint">
                            <strong>Keyboard controls:</strong><br />
                            Click ring and press arrows keys to rotate<br />
                            Space bar to check for words
                        </div>
                    </details>
                </div>

                <canvas id="gameCanvas" width="600" height="600"></canvas>

                <div class="controls">
                    <button class="check-button" onclick="checkAllPositions()">
                        Check for Words (Space)
                    </button>
                </div>

                <div id="results" class="results" style="display: none"></div>
            </div>

            <div class="sidebar">
                <div id="score-panel">
                    <div>
                        <h2 id="playerScore">0</h2>
                        <div class="rank" id="playerRank">Beginner</div>
                        <div class="score" id="wordCount">0 words found</div>
                    </div>
                </div>

                <div class="word-bank">
                    <h3>Word Bank</h3>
                    <div class="found-words" id="foundWords">
                        <em>Found words will appear here...</em>
                    </div>
                </div>
            </div>
        </div>

        <dialog id="ranksDialog" class="ranks-dialog">
            <div class="dialog-content">
                <div class="dialog-header">
                    <h2>Stellar Progression</h2>
                    <button class="close-button" onclick="closeRanksDialog()">
                        ×
                    </button>
                </div>

                <div class="dialog-body">
                    <div class="ranks-grid">
                        <div class="rank-item beginner">
                            <div class="rank-icon">🌱</div>
                            <div class="rank-info">
                                <h3>Beginner</h3>
                                <p>0 points</p>
                            </div>
                        </div>

                        <div class="rank-item">
                            <div class="rank-icon">👍</div>
                            <div class="rank-info">
                                <h3>Good</h3>
                                <p>1+ points</p>
                            </div>
                        </div>

                        <div class="rank-item">
                            <div class="rank-icon">⭐</div>
                            <div class="rank-info">
                                <h3>Great</h3>
                                <p>10+ points</p>
                            </div>
                        </div>

                        <div class="rank-item">
                            <div class="rank-icon">🚀</div>
                            <div class="rank-info">
                                <h3>Voyager</h3>
                                <p>20+ points</p>
                            </div>
                        </div>

                        <div class="rank-item">
                            <div class="rank-icon">✨</div>
                            <div class="rank-info">
                                <h3>Stellar</h3>
                                <p>30+ points</p>
                            </div>
                        </div>

                        <div class="rank-item">
                            <div class="rank-icon">🔴</div>
                            <div class="rank-info">
                                <h3>Red Giant</h3>
                                <p>40+ points</p>
                            </div>
                        </div>

                        <div class="rank-item">
                            <div class="rank-icon">⚪</div>
                            <div class="rank-info">
                                <h3>White Dwarf</h3>
                                <p>50+ points</p>
                            </div>
                        </div>

                        <div class="rank-item">
                            <div class="rank-icon">💫</div>
                            <div class="rank-info">
                                <h3>Neutron Star</h3>
                                <p>60+ points</p>
                            </div>
                        </div>

                        <div class="rank-item">
                            <div class="rank-icon">💥</div>
                            <div class="rank-info">
                                <h3>Supernova</h3>
                                <p>70+ points</p>
                            </div>
                        </div>

                        <div class="rank-item legendary">
                            <div class="rank-icon">🕳️</div>
                            <div class="rank-info">
                                <h3>Black Hole</h3>
                                <p>80+ points</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </dialog>
        <script>
            // Constants - Ring diameters, colors, etc.
            const FIRST_RING_COLOR = "#ff6b6b";
            const SECOND_RING_COLOR = "#297a23";
            const THIRD_RING_COLOR = "#45b7d1";
            const FOURTH_RING_COLOR = "#9945d1";
            const FIFTH_RING_COLOR = "#9e297b";

            const FIRST_RING_RADIUS = 60;
            const SECOND_RING_RADIUS = 110;
            const THIRD_RING_RADIUS = 160;
            const FOURTH_RING_RADIUS = 210;
            const FIFTH_RING_RADIUS = 260;

            const RING_RADII = [
                FIRST_RING_RADIUS,
                SECOND_RING_RADIUS,
                THIRD_RING_RADIUS,
                FOURTH_RING_RADIUS,
                FIFTH_RING_RADIUS,
            ];

            // Game state - now with flexible letter positioning
            const gameState = {
                letters: [
                    // First ring
                    {
                        letter: "F",
                        radius: FIRST_RING_RADIUS,
                        angle: 0,
                        color: FIRST_RING_COLOR,
                        ring: "inner",
                    },
                    // {
                    //     letter: "A",
                    //     radius: FIRST_RING_RADIUS,
                    //     angle: 60,
                    //     color: FIRST_RING_COLOR,
                    //     ring: "inner",
                    // },
                    {
                        letter: "I",
                        radius: FIRST_RING_RADIUS,
                        angle: 120,
                        color: FIRST_RING_COLOR,
                        ring: "inner",
                    },
                    {
                        letter: "O",
                        radius: FIRST_RING_RADIUS,
                        angle: 180,
                        color: FIRST_RING_COLOR,
                        ring: "inner",
                    },
                    // {
                    //     letter: "I",
                    //     radius: FIRST_RING_RADIUS,
                    //     angle: 240,
                    //     color: FIRST_RING_COLOR,
                    //     ring: "inner",
                    // },
                    {
                        letter: "U",
                        radius: FIRST_RING_RADIUS,
                        angle: 300,
                        color: FIRST_RING_COLOR,
                        ring: "inner",
                    },

                    // Second ring
                    {
                        letter: "S",
                        radius: SECOND_RING_RADIUS,
                        angle: 30,
                        color: SECOND_RING_COLOR,
                        ring: "middle",
                    },
                    // {
                    //     letter: "C",
                    //     radius: SECOND_RING_RADIUS,
                    //     angle: 60,
                    //     color: SECOND_RING_COLOR,
                    //     ring: "middle",
                    // },
                    {
                        letter: "R",
                        radius: SECOND_RING_RADIUS,
                        angle: 90,
                        color: SECOND_RING_COLOR,
                        ring: "middle",
                    },
                    {
                        letter: "P",
                        radius: SECOND_RING_RADIUS,
                        angle: 120,
                        color: SECOND_RING_COLOR,
                        ring: "middle",
                    },
                    {
                        letter: "W",
                        radius: SECOND_RING_RADIUS,
                        angle: 180,
                        color: SECOND_RING_COLOR,
                        ring: "middle",
                    },
                    {
                        letter: "L",
                        radius: SECOND_RING_RADIUS,
                        angle: 210,
                        color: SECOND_RING_COLOR,
                        ring: "middle",
                    },
                    // {
                    //     letter: "L",
                    //     radius: SECOND_RING_RADIUS,
                    //     angle: 240,
                    //     color: SECOND_RING_COLOR,
                    //     ring: "middle",
                    // },
                    {
                        letter: "T",
                        radius: SECOND_RING_RADIUS,
                        angle: 300,
                        color: SECOND_RING_COLOR,
                        ring: "middle",
                    },

                    // Third ring
                    {
                        letter: "I",
                        radius: THIRD_RING_RADIUS,
                        angle: 30,
                        color: THIRD_RING_COLOR,
                        ring: "outer",
                    },
                    {
                        letter: "O",
                        radius: THIRD_RING_RADIUS,
                        angle: 90,
                        color: THIRD_RING_COLOR,
                        ring: "outer",
                    },
                    {
                        letter: "E",
                        radius: THIRD_RING_RADIUS,
                        angle: 180,
                        color: THIRD_RING_COLOR,
                        ring: "outer",
                    },
                    {
                        letter: "I",
                        radius: THIRD_RING_RADIUS,
                        angle: 210,
                        color: THIRD_RING_COLOR,
                        ring: "outer",
                    },

                    // Fourth ring
                    {
                        letter: "R",
                        radius: FOURTH_RING_RADIUS,
                        angle: 30,
                        color: FOURTH_RING_COLOR,
                        ring: "fourth",
                    },
                    {
                        letter: "S",
                        radius: FOURTH_RING_RADIUS,
                        angle: 90,
                        color: FOURTH_RING_COLOR,
                        ring: "fourth",
                    },
                    {
                        letter: "R",
                        radius: FOURTH_RING_RADIUS,
                        angle: 180,
                        color: FOURTH_RING_COLOR,
                        ring: "fourth",
                    },
                    {
                        letter: "L",
                        radius: FOURTH_RING_RADIUS,
                        angle: 210,
                        color: FOURTH_RING_COLOR,
                        ring: "fourth",
                    },

                    // Fifth ring
                    {
                        letter: "I",
                        radius: FIFTH_RING_RADIUS,
                        angle: 30,
                        color: FIFTH_RING_COLOR,
                        ring: "fifth",
                    },
                    {
                        letter: "E",
                        radius: FIFTH_RING_RADIUS,
                        angle: 90,
                        color: FIFTH_RING_COLOR,
                        ring: "fifth",
                    },
                    {
                        letter: "Y",
                        radius: FIFTH_RING_RADIUS,
                        angle: 210,
                        color: FIFTH_RING_COLOR,
                        ring: "fifth",
                    },
                ],
                rings: {
                    inner: {
                        position: 0,
                        targetPosition: 0,
                        radius: FIRST_RING_RADIUS,
                        color: FIRST_RING_COLOR,
                    },
                    middle: {
                        position: 0,
                        targetPosition: 0,
                        radius: SECOND_RING_RADIUS,
                        color: SECOND_RING_COLOR,
                    },
                    outer: {
                        position: 0,
                        targetPosition: 0,
                        radius: THIRD_RING_RADIUS,
                        color: THIRD_RING_COLOR,
                    },
                    fourth: {
                        position: 0,
                        targetPosition: 0,
                        radius: FOURTH_RING_RADIUS,
                        color: FOURTH_RING_COLOR,
                    },
                    fifth: {
                        position: 0,
                        targetPosition: 0,
                        radius: FIFTH_RING_RADIUS,
                        color: FIFTH_RING_COLOR,
                    },
                },
                shuffled: false,
                foundWords: new Set(),
                numWordsInGrandAlignment: 5,
                score: 0,
                maxScore: 142,
                dragState: null,
                selectedRing: null,
                center: { x: 300, y: 300 },
                sun: { letter: "L", radius: 20, color: "#ffdd44" },
            };

            // Word list
            async function loadDictionary() {
                try {
                    const response = await fetch("./valid_words.txt");
                    const text = await response.text();

                    const words = text
                        .split("\n")
                        .map((word) => word.trim().toUpperCase())
                        .filter(
                            (word) => word.length >= 3 && word.length <= 11,
                        );

                    console.log(`Loaded ${words.length} words`);
                    return new Set(words);
                } catch (error) {
                    console.error("Failed to load dictionary:", error);
                    return new Set(["SPACE", "STAR", "PLANET"]); // Fallback
                }
            }
            let dictionary;
            loadDictionary().then((raw_dictionary) => {
                dictionary = raw_dictionary;
            });

            // Canvas setup
            const canvas = document.getElementById("gameCanvas");
            const ctx = canvas.getContext("2d");

            // Score dialog setup
            const showRanksDialogButton =
                document.getElementById("score-panel");
            const dialog = document.getElementById("ranksDialog");

            // Animation loop
            function animate() {
                update();
                draw();
                requestAnimationFrame(animate);
            }

            function update() {
                // Smooth rotation animations with proper wraparound handling
                Object.keys(gameState.rings).forEach((ringName) => {
                    const ring = gameState.rings[ringName];
                    let diff = ring.targetPosition - ring.position;

                    // Handle wraparound: choose the shortest angular path
                    while (diff > 180) diff -= 360;
                    while (diff < -180) diff += 360;

                    if (Math.abs(diff) > 0.01) {
                        ring.position += diff * 0.15; // Smooth interpolation
                    }
                });
            }

            function draw() {
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Draw orbital rings (guidelines)
                drawOrbitalRings();

                // Draw reading direction indicators
                drawReadingIndicators();

                // Shuffle planets
                shufflePlanets();

                // Draw planets
                drawPlanets();

                // Draw sun
                drawSun();

                // Draw any word visualization
                drawWordLines();
            }

            function drawOrbitalRings() {
                // Draw rings based on unique radii from letters
                const radii = [
                    ...new Set(
                        Object.values(gameState.rings).map(
                            (ring) => ring.radius,
                        ),
                    ),
                ];
                radii.forEach((radius) => {
                    const ringName = Object.keys(gameState.rings).find(
                        (name) => gameState.rings[name].radius === radius,
                    );
                    const isSelected = gameState.selectedRing === ringName;

                    ctx.strokeStyle = isSelected ? "#ffdd44" : "#444";
                    ctx.lineWidth = isSelected ? 2 : 1;
                    ctx.setLineDash(isSelected ? [] : [5, 5]);

                    ctx.beginPath();
                    ctx.arc(
                        gameState.center.x,
                        gameState.center.y,
                        radius,
                        0,
                        Math.PI * 2,
                    );
                    ctx.stroke();
                });

                ctx.setLineDash([]);
            }

            function drawReadingIndicators() {
                ctx.strokeStyle = "#666";
                ctx.lineWidth = 1;
                ctx.font = "10px Arial";
                ctx.fillStyle = "#888";

                // Draw subtle lines at all 12 positions
                for (let pos = 0; pos < 8; pos++) {
                    const angle = ((pos * 45 - 90) * Math.PI) / 180;

                    if (pos % 2 === 1) {
                        // Show main positions (12, 3, 6, 9)
                        const x1 = gameState.center.x + 60 * Math.cos(angle);
                        const y1 = gameState.center.y + 60 * Math.sin(angle);
                        const x2 = gameState.center.x + 300 * Math.cos(angle);
                        const y2 = gameState.center.y + 300 * Math.sin(angle);

                        ctx.globalAlpha = 0.3;
                        ctx.beginPath();
                        ctx.moveTo(x1, y1);
                        ctx.lineTo(x2, y2);
                        ctx.strokeStyle = "#ffdd44";
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        ctx.globalAlpha = 1;
                    }
                }
            }

            function drawPlanets() {
                gameState.letters.forEach((letterObj) => {
                    // Calculate current position based on ring rotation
                    const ringRotation =
                        (gameState.rings[letterObj.ring].position * Math.PI) /
                        180;
                    const totalAngle =
                        (letterObj.angle * Math.PI) / 180 +
                        ringRotation -
                        Math.PI / 2;

                    const x =
                        gameState.center.x +
                        letterObj.radius * Math.cos(totalAngle);
                    const y =
                        gameState.center.y +
                        letterObj.radius * Math.sin(totalAngle);

                    // Planet body
                    ctx.fillStyle = letterObj.color;
                    ctx.beginPath();
                    ctx.arc(x, y, 18, 0, Math.PI * 2);
                    ctx.fill();

                    // Planet border
                    ctx.strokeStyle = "#fff";
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // Letter
                    ctx.fillStyle = "white";
                    ctx.font = "bold 22px Arial";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(letterObj.letter, x, y);
                });
            }

            function drawSun() {
                const sun = gameState.sun;

                // Sun glow
                const gradient = ctx.createRadialGradient(
                    gameState.center.x,
                    gameState.center.y,
                    0,
                    gameState.center.x,
                    gameState.center.y,
                    sun.radius + 10,
                );
                gradient.addColorStop(0, "#ffdd44");
                gradient.addColorStop(0.7, "#ffaa00");
                gradient.addColorStop(1, "rgba(255, 170, 0, 0)");

                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(
                    gameState.center.x,
                    gameState.center.y,
                    sun.radius + 10,
                    0,
                    Math.PI * 2,
                );
                ctx.fill();

                // Sun body
                ctx.fillStyle = sun.color;
                ctx.beginPath();
                ctx.arc(
                    gameState.center.x,
                    gameState.center.y,
                    sun.radius,
                    0,
                    Math.PI * 2,
                );
                ctx.fill();

                // Sun border
                ctx.strokeStyle = "#ffaa00";
                ctx.lineWidth = 3;
                ctx.stroke();

                // Sun letter
                ctx.fillStyle = "#333";
                ctx.font = "bold 24px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(
                    gameState.sun.letter,
                    gameState.center.x,
                    gameState.center.y,
                );
            }

            function drawWordLines() {
                // This will show visual connections for found words
                // Implementation can be added later for visual feedback
            }

            // Input handling
            canvas.addEventListener("mousedown", handleMouseDown);
            canvas.addEventListener("mousemove", handleMouseMove);
            canvas.addEventListener("mouseup", handleMouseUp);
            canvas.addEventListener("touchstart", handleTouchStart);
            canvas.addEventListener("touchmove", handleTouchMove);
            canvas.addEventListener("touchend", handleTouchEnd);

            // Keyboard controls
            document.addEventListener("keydown", handleKeyDown);

            // Rank board input handling
            showRanksDialogButton.addEventListener("click", () => {
                dialog.showModal();
            });

            function handleKeyDown(e) {
                if (!gameState.selectedRing) return;

                switch (e.code) {
                    case "ArrowLeft":
                        e.preventDefault();
                        rotateRing(gameState.selectedRing, -1);
                        break;
                    case "ArrowRight":
                        e.preventDefault();
                        rotateRing(gameState.selectedRing, 1);
                        break;
                    case "ArrowUp":
                        e.preventDefault();
                        gameState.selectedRing = getNextRing(
                            gameState.selectedRing,
                        );
                        break;
                    case "ArrowDown":
                        e.preventDefault();
                        gameState.selectedRing = getPrevoiusRing(
                            gameState.selectedRing,
                        );
                        break;
                    case "Space":
                        e.preventDefault();
                        checkAllPositions();
                        break;
                }
            }

            function handleMouseDown(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;
                startDrag(x, y);
            }

            function handleMouseMove(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;
                updateDrag(x, y);
            }

            function handleMouseUp(e) {
                endDrag();
            }

            function handleTouchStart(e) {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[0];
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const x = (touch.clientX - rect.left) * scaleX;
                const y = (touch.clientY - rect.top) * scaleY;
                startDrag(x, y);
            }

            function handleTouchMove(e) {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[0];
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const x = (touch.clientX - rect.left) * scaleX;
                const y = (touch.clientY - rect.top) * scaleY;
                updateDrag(x, y);
            }

            function handleTouchEnd(e) {
                e.preventDefault();
                endDrag();
            }

            function startDrag(x, y) {
                const distance = Math.sqrt(
                    (x - gameState.center.x) ** 2 +
                        (y - gameState.center.y) ** 2,
                );

                // Determine which ring is being clicked
                let targetRing = null;
                let minDiff = Infinity;

                Object.keys(gameState.rings).forEach((ringName) => {
                    const ring = gameState.rings[ringName];
                    const diff = Math.abs(distance - ring.radius);
                    if (diff < 30 && diff < minDiff) {
                        // 30px tolerance
                        minDiff = diff;
                        targetRing = ringName;
                    }
                });

                if (targetRing) {
                    // Select the ring
                    gameState.selectedRing = targetRing;

                    // Start drag for rotation
                    const angle = Math.atan2(
                        y - gameState.center.y,
                        x - gameState.center.x,
                    );
                    gameState.dragState = {
                        ring: targetRing,
                        startAngle: angle,
                        startPosition: gameState.rings[targetRing].position,
                    };
                    canvas.style.cursor = "grabbing";
                } else {
                    // Click on empty space deselects
                    gameState.selectedRing = null;
                }
            }

            function updateDrag(x, y) {
                if (!gameState.dragState) return;

                const angle = Math.atan2(
                    y - gameState.center.y,
                    x - gameState.center.x,
                );

                // Calculate the shortest angular distance
                let deltaAngle = angle - gameState.dragState.startAngle;

                // Normalize to [-π, π] range to prevent wrapping issues
                while (deltaAngle > Math.PI) deltaAngle -= 2 * Math.PI;
                while (deltaAngle < -Math.PI) deltaAngle += 2 * Math.PI;

                const deltaPosition = (deltaAngle * 180) / Math.PI;
                let newPosition =
                    gameState.dragState.startPosition + deltaPosition;

                // Snap to nearest 30-degree increment
                newPosition = Math.round(newPosition / 30) * 30;

                gameState.rings[gameState.dragState.ring].targetPosition =
                    newPosition;
            }

            function endDrag() {
                gameState.dragState = null;
                canvas.style.cursor = "pointer";
            }

            function closeRanksDialog() {
                dialog.close();
            }

            // Scoring system
            const RANKS = [
                { name: "Beginner", min: 0 },
                { name: "Good", min: Math.floor(gameState.maxScore * 0.1) },
                { name: "Great", min: Math.floor(gameState.maxScore * 0.2) },
                { name: "Voyager", min: Math.floor(gameState.maxScore * 0.3) },
                { name: "Stellar", min: Math.floor(gameState.maxScore * 0.4) },
                {
                    name: "Red Giant",
                    min: Math.floor(gameState.maxScore * 0.5),
                },
                {
                    name: "White Dwarf",
                    min: Math.floor(gameState.maxScore * 0.6),
                },
                {
                    name: "Supernova",
                    min: Math.floor(gameState.maxScore * 0.7),
                },
                {
                    name: "Neutron Star",
                    min: Math.floor(gameState.maxScore * 0.8),
                },
                { name: "Black Hole", min: gameState.maxScore },
            ];

            function calculateWordScore(word, hasSun = false) {
                let baseScore;
                const length = word.length;

                // Base scoring (Spelling Bee style)
                if (length === 3) {
                    baseScore = 1;
                } else if (length === 4) {
                    baseScore = 2;
                } else {
                    baseScore = length; // 5+ letters get 1 point per letter
                }

                // Bonuses
                if (hasSun) baseScore += 1; // Sun letter bonus

                return baseScore;
            }

            function getRank(score) {
                for (let i = RANKS.length - 1; i >= 0; i--) {
                    if (score >= RANKS[i].min) {
                        return RANKS[i].name;
                    }
                }
                return "Beginner";
            }

            function updateScoreDisplay() {
                document.getElementById("playerScore").textContent =
                    gameState.score;
                document.getElementById("playerRank").textContent = getRank(
                    gameState.score,
                );
                document.getElementById("wordCount").textContent =
                    `${gameState.foundWords.size} words found`;
            }

            function rotateRing(ringName, direction) {
                const ring = gameState.rings[ringName];
                let newPosition = ring.targetPosition + direction * 30;

                ring.targetPosition = newPosition;
            }

            function getLettersAtPosition(position) {
                const positionAngle = position * 30;
                const oppositeAngle = (positionAngle + 180) % 360;

                // Find letters at the position angle
                const positionLetters = [];
                // Find letters at the opposite angle
                const oppositeLetters = [];

                gameState.letters.forEach((letterObj) => {
                    const ringRotation =
                        gameState.rings[letterObj.ring].position;
                    const currentAngle = (letterObj.angle + ringRotation) % 360;
                    const normalizedCurrentAngle =
                        currentAngle < 0 ? currentAngle + 360 : currentAngle;

                    // Check if aligns with position angle
                    const positionDiff = Math.abs(
                        normalizedCurrentAngle - positionAngle,
                    );
                    const positionWrappedDiff = Math.min(
                        positionDiff,
                        360 - positionDiff,
                    );

                    if (positionWrappedDiff < 15) {
                        positionLetters.push({
                            letter: letterObj.letter,
                            radius: letterObj.radius,
                        });
                    }

                    // Check if aligns with opposite angle
                    const oppositeDiff = Math.abs(
                        normalizedCurrentAngle -
                            (oppositeAngle < 0
                                ? oppositeAngle + 360
                                : oppositeAngle),
                    );
                    const oppositeWrappedDiff = Math.min(
                        oppositeDiff,
                        360 - oppositeDiff,
                    );

                    if (oppositeWrappedDiff < 15) {
                        oppositeLetters.push({
                            letter: letterObj.letter,
                            radius: letterObj.radius,
                        });
                    }
                });

                // Add in blanks for positionLetters and oppositeLetters
                for (let radius of RING_RADII) {
                    if (
                        !positionLetters.some(
                            (letterObj) => letterObj.radius == radius,
                        )
                    ) {
                        positionLetters.push({
                            letter: " ",
                            radius,
                        });
                    }

                    if (
                        !oppositeLetters.some(
                            (letterObj) => letterObj.radius == radius,
                        )
                    ) {
                        oppositeLetters.push({
                            letter: " ",
                            radius,
                        });
                    }
                }

                // Sort position letters by radius (outermost to innermost)
                positionLetters.sort((a, b) => b.radius - a.radius);

                // Sort opposite letters by radius in reverse (innermost to outermost)
                oppositeLetters.sort((a, b) => a.radius - b.radius);

                // Build the sequence: position letters + sun + opposite letters
                const fullSequence = [];

                // Add position side letters
                positionLetters.forEach((item) =>
                    fullSequence.push(item.letter),
                );

                // Add sun in the middle
                fullSequence.push(gameState.sun.letter);

                // Add opposite side letters
                oppositeLetters.forEach((item) =>
                    fullSequence.push(item.letter),
                );

                return fullSequence;
            }

            function findWordsInAlignment(letters, position) {
                const words = [];
                const positionAngle = position * 30;

                // Determine reading direction based on sector
                const normalizedAngle = ((positionAngle % 360) + 360) % 360;
                const isVerticalSector =
                    normalizedAngle >= 315 ||
                    normalizedAngle <= 45 ||
                    (normalizedAngle >= 135 && normalizedAngle <= 225);

                // Check all possible starting positions and lengths in the ordered sequence
                // Determine if this word includes the sun
                const includesSun = letters.includes(gameState.sun.letter);

                // Check if this forms a valid word
                const potentialWords = letters.join("").trim().split(" ");
                for (const word of potentialWords) {
                    if (dictionary.has(word)) {
                        words.push({
                            word: word,
                            direction: isVerticalSector
                                ? "top-to-bottom"
                                : "left-to-right",
                            letters,
                            includesSun: includesSun,
                        });
                    }
                }

                // Remove duplicates based on word text
                const uniqueWords = [];
                const seen = new Set();
                words.forEach((wordObj) => {
                    if (!seen.has(wordObj.word)) {
                        seen.add(wordObj.word);
                        uniqueWords.push(wordObj);
                    }
                });

                return uniqueWords;
            }

            function checkAllPositions() {
                const allWords = [];
                const wordDetails = [];
                const positionsToCheck = [0, 1, 8, 9, 10, 11];
                let newWordsFound = false;

                for (let position of positionsToCheck) {
                    const letters = getLettersAtPosition(position);
                    const wordObjects = findWordsInAlignment(letters, position);

                    if (wordObjects.length > 0) {
                        // Check for multi-word bonus at this position
                        const isMultiWord = wordObjects.length > 1;
                        const isGrandAlignment =
                            wordObjects.length ==
                            gameState.numWordsInGrandAlignment;

                        // 2 bonus points for each additional word found!
                        let bonusScore = 0;
                        if (wordObjects.length > 1 && !isGrandAlignment) {
                            bonusScore +=
                                2 *
                                (gameState.numWordsInGrandAlignment -
                                    wordObjects.length);
                        } else if (isGrandAlignment) bonusScore += 15;

                        wordObjects.forEach((wordObj) => {
                            allWords.push(wordObj.word);

                            // Calculate score for new words
                            if (!gameState.foundWords.has(wordObj.word)) {
                                newWordsFound = true;
                                const hasSun = wordObj.word.includes(
                                    gameState.sun.letter,
                                );
                                let wordScore = calculateWordScore(
                                    wordObj.word,
                                    hasSun,
                                );
                                wordScore += bonusScore;
                                gameState.score += wordScore;
                            }
                        });

                        wordDetails.push({
                            position: position,
                            letters: letters,
                            words: wordObjects,
                        });
                    }
                }

                // Add to word bank
                allWords.forEach((word) => {
                    gameState.foundWords.add(word);
                });

                updateWordBank();
                updateScoreDisplay();

                if (newWordsFound) {
                    // Brief score animation could go here
                }
            }

            function updateWordBank() {
                const foundWordsEl = document.getElementById("foundWords");

                if (gameState.foundWords.size === 0) {
                    foundWordsEl.innerHTML =
                        "<em>Found words will appear here...</em>";
                } else {
                    foundWordsEl.innerHTML = "";

                    // // Sort words by length, then alphabetically
                    // const sortedWords = [...gameState.foundWords].sort(
                    //     (a, b) => {
                    //         if (a.length !== b.length)
                    //             return a.length - b.length;
                    //         return a.localeCompare(b);
                    //     },
                    // );

                    gameState.foundWords.forEach((word) => {
                        const wordEl = document.createElement("div");
                        wordEl.className = "word-item";
                        wordEl.textContent = word;
                        foundWordsEl.appendChild(wordEl);
                    });
                }
            }

            // Helper Functions
            function getNextRing(currentRing) {
                switch (currentRing) {
                    case "inner":
                        return "middle";
                    case "middle":
                        return "outer";
                    case "outer":
                        return "fourth";
                    case "fourth":
                        return "fifth";
                    case "fifth":
                        return "inner";
                    default:
                        return null;
                }
            }

            function getPrevoiusRing(currentRing) {
                switch (currentRing) {
                    case "inner":
                        return "fifth";
                    case "middle":
                        return "inner";
                    case "outer":
                        return "middle";
                    case "fourth":
                        return "outer";
                    case "fifth":
                        return "fourth";
                    default:
                        return null;
                }
            }

            function shufflePlanets() {
                if (!gameState.shuffled) {
                    const rings = gameState.rings;
                    for (let ring of Object.keys(rings)) {
                        let randomRotation =
                            30 * Math.floor(12 * Math.random());
                        rings[ring].targetPosition += randomRotation;
                    }
                    gameState.shuffled = true;
                }
            }

            // Initialize the game
            updateScoreDisplay();
            animate();
        </script>
    </body>
</html>
